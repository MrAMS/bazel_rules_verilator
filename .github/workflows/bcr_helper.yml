name: BCR Helper

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  update-release-with-bcr-info:
    name: Calc Hash & Update Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Hash & Generate Markdown
        id: calc
        run: |
          # 1. å˜é‡å‡†å¤‡
          REPO_NAME="${{ github.event.repository.name }}"
          TAG_NAME="${{ github.ref_name }}"
          PURE_VERSION="${TAG_NAME#v}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${TAG_NAME}.tar.gz"
          FILENAME="${REPO_NAME}-${TAG_NAME}.tar.gz"

          echo "â³ Waiting for GitHub archive generation..."
          sleep 5 #ç¨ä½œç­‰å¾…ï¼Œé˜²æ­¢ 404

          echo "â¬‡ï¸ Downloading: $DOWNLOAD_URL"
          curl -L -H 'Cache-Control: no-cache' -o "$FILENAME" "$DOWNLOAD_URL"

          # 2. è®¡ç®— Hash & Prefix
          HASH_VALUE=$(openssl dgst -sha256 -binary "$FILENAME" | openssl base64 -A)
          SRI_HASH="sha256-$HASH_VALUE"
          PREFIX_DIR=$(tar -tzf "$FILENAME" | head -1 | cut -f1 -d"/")

          # 3. ç”Ÿæˆ JSON å­—ç¬¦ä¸²
          # ä½¿ç”¨ jq ç”Ÿæˆå‹ç¼©åçš„ JSONï¼Œæ–¹ä¾¿åµŒå…¥ Markdown
          JSON_CONTENT=$(jq -n \
            --arg integrity "$SRI_HASH" \
            --arg strip_prefix "$PREFIX_DIR" \
            --arg url "$DOWNLOAD_URL" \
            '{integrity: $integrity, strip_prefix: $strip_prefix, url: $url}')

          # 4. ç¼–å†™ Release è¯´æ˜æ–‡ä»¶ (Markdown)
          # è¿™é‡Œå®šä¹‰ä½ åœ¨ Release é¡µé¢çœ‹åˆ°çš„å†…å®¹
          echo "## ğŸš€ BCR Submission Data" > release_body.md
          echo "To submit this version to the Bazel Central Registry, copy the block below into:" >> release_body.md
          echo "\`modules/rules_verilator/$PURE_VERSION/source.json\`" >> release_body.md
          echo "" >> release_body.md
          echo "\`\`\`json" >> release_body.md
          # ä½¿ç”¨ jq é‡æ–°æ ¼å¼åŒ–è¾“å‡ºï¼Œä½¿å…¶ç¾è§‚ï¼ˆå¤šè¡Œç¼©è¿›ï¼‰
          echo "$JSON_CONTENT" | jq . >> release_body.md
          echo "\`\`\`" >> release_body.md

          echo "" >> release_body.md
          echo "### âœ… Pre-submission Checklist" >> release_body.md
          echo "- [ ] \`MODULE.bazel\` version is set to **$PURE_VERSION**" >> release_body.md
          echo "- [ ] \`source.json\` integrity matches above" >> release_body.md

      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          # è¯»å–ä¸Šä¸€æ­¥ç”Ÿæˆçš„æ–‡ä»¶ä½œä¸º Release å†…å®¹
          body_path: release_body.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
